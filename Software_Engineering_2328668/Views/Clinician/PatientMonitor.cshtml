@* Monitor shell: shows identity, date/duration controls, and placeholders for heatmap and stats. *@

@model Software_Engineering_2328668.Models.ViewModels.MonitorPageViewModel
@{
    Layout = "~/Views/Shared/_ClinicianPatientLayout.cshtml";
    ViewData["ActiveTab"] = "monitor";
    ViewData["Title"] = "Patient Monitor";
}

<section id="monitor-root"
         data-pid="@Model.PatientId"
         data-default-date="@Model.SelectedDate"
         data-default-duration="300">

    <h1 style="margin:0 0 8px 0;">Patient Monitor</h1>
    <div style="margin-bottom:12px; color:#4e5d74;">
        <strong>Patient:</strong> @Model.PatientName
        &nbsp;|&nbsp; <strong>PID:</strong> @Model.PatientId
        &nbsp;|&nbsp; <strong>Sensore ID:</strong> @Model.SensoreId
    </div>

    <!-- TOP CONTROLS ROW (Date / Duration / Download) -->
    <div class="controls-row" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
        <label for="dateSelect">Date:</label>
        <select id="dateSelect" name="date" style="padding:6px 8px;">
            @foreach (var d in Model.AvailableDates)
            {
                <option value="@d" selected="@(d == Model.SelectedDate ? "selected" : null)">@d</option>
            }
        </select>

        <label for="durSelect">Duration:</label>
        <select id="durSelect" name="duration" style="padding:6px 8px;">
            <option value="30">30 sec</option>
            <option value="60">1 min</option>
            <option value="120">2 min</option>
            <option value="300" selected>5 min</option>
        </select>

        <button type="button" id="btnDownload" style="margin-left:auto; padding:6px 12px;">Download PNG</button>
    </div>

    <!-- HEATMAP PANEL: heatmap + legend + stats, with spinner overlay -->
    <div id="hmPanel" style="position:relative; display:flex; align-items:flex-start; gap:16px; border:1px solid #e5edf6; border-radius:12px; padding:12px; margin-bottom:12px;">
        <!-- Square heatmap -->
        <canvas id="heatmap" width="512" height="512" style="max-width:100%; background:#fff; display:block;"></canvas>

        <!-- Legend + Stats column -->
        <div class="legend-stats" style="display:flex; align-items:flex-start; gap:16px;">
            <!-- Widened legend so labels don’t clip -->
            <canvas id="legend" width="100" height="512" style="display:block;"></canvas>

            <!-- Vertical stats column (5 boxes) -->
            <div class="stats-col" style="display:flex; flex-direction:column; gap:10px;">
                <div class="stat-box">
                    <div class="stat-name">Peak</div>
                    <div id="statPeakVal" class="stat-value">—</div>
                </div>
                <div class="stat-box">
                    <div class="stat-name">Avg</div>
                    <div id="statAvgVal" class="stat-value">—</div>
                </div>
                <div class="stat-box">
                    <div class="stat-name">Contact</div>
                    <div id="statContactVal" class="stat-value">—</div>
                </div>
                <div class="stat-box">
                    <div class="stat-name">CoV</div>
                    <div id="statCovVal" class="stat-value">—</div>
                </div>
                <div class="stat-box">
                    <div class="stat-name">PPI (10s)</div>
                    <div id="statPpiVal" class="stat-value">—</div>
                </div>
            </div>
        </div>

        <!-- Spinner overlay (covers the whole panel) -->
        <div id="loading" class="loading-overlay" aria-hidden="true" style="display:none;">
            <div class="spinner"></div>
        </div>
    </div>

    <!-- PLAYBACK ROW BELOW THE HEATMAP -->
    <div class="playback-row" style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
        <button type="button" id="btnToggle" title="Play/Pause" style="padding:6px 10px; font-size:18px; line-height:1;">▶</button>
        <input type="range" id="timeSlider" min="0" max="0" value="0" style="flex:1;" title="Scrub" />
        <span id="lblTime" style="min-width:120px; text-align:right; color:#4e5d74;">00:00 / 00:00</span>
    </div>

</section>

@section Scripts {
    <!-- cache-bust to ensure browser picks the new JS -->
    <script src="/js/monitor.js?v=3"></script>
}
